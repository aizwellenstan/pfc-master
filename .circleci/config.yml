version: 2.1

orbs:
  ruby: circleci/ruby@1.1.0
  node: circleci/node@2

jobs:
  build:
    docker:
      - image: circleci/ruby:2.5.1-node-browsers
        environment:
          - BUNDLER_VERSION: 2.1.4
          - RAILS_ENV: test
      - image: circleci/mysql:5.6
        environment:
          - MYSQL_ALLOW_EMPTY_PASSWORD: 'true'
          - MYSQL_ROOT_HOST: '%'
    
    working_directory: ~/projects/pfc-master

    steps:
      - checkout
      # - ruby/install-deps

      # Download and cache dependencies
      - restore_cache:
        keys:
          - v1-dependencies-{{ checksum "Gemfile.lock" }}
          # fallback to using the latest cache if no exact match is found
          - v1-dependencies-
      - run:
        name: install dependencies
          command: |
# bundler2.0.1以降のものを使っているのであれば、環境変数と合わせて指定する必要がある
            gem install bundler -v 2.1.4
            bundle install --jobs=4 --retry=3 --path vendor/bundle
      
      - save_cache:
        paths:
          - ./vendor/bundle
        key: v1-dependencies-{{ checksum "Gemfile.lock" }}
      
      - run: mv config/database.yml.ci config/database.yml
      
      # Database setup
      - run: bundle exec rake db:create
      - run: bundle exec rake db:schema:load

# rubocopを走らせる記述
      - run:
        name: Rubocop
        command: bundle exec rubocop

# rspecを走らせる記述です。
      # run tests!
      - run:
        name: run tests
        command: |
          mkdir /tmp/test-results
          TEST_FILES="$(circleci tests glob "spec/**/*_spec.rb" | \
            circleci tests split --split-by=timings)"

# ③ここでRspecJunitFormatterというgemをインストールしていないとエラーになります。gemfileに記述しましょう。
          bundle exec rspec \
          --format progress \
          --format RspecJunitFormatter \
          --out /tmp/test-results/rspec.xml \
          --format progress \
          $TEST_FILES

      # collect reports
      - store_test_results:
        path: /tmp/test-results
      - store_artifacts:
        path: /tmp/test-results
        destination: test-results

#   test:
#     parallelism: 3
#     docker:
#       - image: circleci/ruby:2.5.1-node-browsers
#         environment:
#           DB_HOST: 127.0.0.1
#           RAILS_ENV: test
#           BUNDLER_VERSION: 2.1.4
#       - image: circleci/mysql:5.6
#         command: --default-authentication-plugin=mysql_native_password
#         environment:
#           MYSQL_ALLOW_EMPTY_PASSWORD: 'true'
#           MYSQL_ROOT_HOST: '%'
#     steps:
#       - checkout
#       - ruby/install-deps
#       - run: mv config/database.yml.ci config/database.yml 
#       - run:
#           name: Wait for DB
#           command: dockerize -wait tcp://localhost:3306 -timeout 1m
#       - run: bundle exec rake db:create
#       - run: bundle exec rake db:schema:load
#       # Run rspec in parallel
#       - ruby/rspec-test
#       - ruby/rubocop-check

# workflows:
#   version: 2
#   build_and_test:
#     jobs:
#       - build
#       - test:
#           requires:
#             - build